{% extends "base.html" %}

{% block title %}Application Details - Job Tracker{% endblock %}

{% block content %}
    <h3 class="box_title">Platforms Administration</h3>
    <div class="glass-container">
        <form method="post" class="form_platforms">
            <input type="text" id="platform_name" name="platform_name" placeholder="Platform Name" class="form-input"><br>
            <input type="text" id="platform_url" name="platform_url" placeholder="Platform URL" class="form-input"><br>
            <button type="submit" class="btn-primary" id="createPlatformBtn" disabled>Insert Platform</button>
        </form>
    </div>
    <div class="fixed-header">
        <table class="header-table">
            <tr class="tab-header">
                <th>Id</th>
                <th>Platform Name</th>
                <th>Platform URL</th>
                <th></th>
                <th></th>
            </tr>
        </table>
    </div>
    <div class="glass-container-tab">
        <table class="tab-platforms">
            {% for platform in platforms %}
                <tr class="tab-body">
                    <td>{{platform.platform_id}}</td>
                    <td>{{platform.name}}</td>
                    <td>{{platform.url}}</td>
                    <td>
                        <i class="fa-solid fa-pen-to-square edit-btn" 
                            style="color: #13ecab; cursor: pointer;" 
                            data-platform-id="{{platform.platform_id}}"
                            data-platform-name="{{platform.name}}"
                            data-platform-url="{{platform.url}}">
                        </i>
                    </td>
                    <td>
                        <i class="fa-solid fa-trash delete-btn" 
                           style="color: #5315d0; cursor: pointer;" 
                           data-platform-id="{{platform.platform_id}}"
                           data-platform-name="{{platform.name}}">
                        </i>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Edit Platform</h3>
                <span class="close">&times;</span>
            </div>
            <form id="editForm" method="post" class="form_platforms">
                <input type="text" id="edit_platform_name" name="platform_name" placeholder="Platform Name" class="form-input" required>
                <input type="text" id="edit_platform_url" name="platform_url" placeholder="Platform URL" class="form-input" required>
                <button type="submit" class="btn-primary">Update Platform</button>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Delete Platform</h3>
                <span class="close-delete">&times;</span>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this platform?</p>
                <div id="applicationsWarning" class="warning-message" style="display: none;">
                    <strong>Warning:</strong> This will also delete <span id="applicationCount"></span> application(s) linked to this platform.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelDelete">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const closeBtn = document.querySelector('.close');
        const editButtons = document.querySelectorAll('.edit-btn');

        // Open modal when edit button is clicked
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const platformId = this.dataset.platformId;
                const platformName = this.dataset.platformName;
                const platformUrl = this.dataset.platformUrl;

                // Set form action to update route
                editForm.action = `/platforms/${platformId}/update`;

                // Populate form fields
                document.getElementById('edit_platform_name').value = platformName;
                document.getElementById('edit_platform_url').value = platformUrl;

                // Show modal
                modal.classList.add('show');
            });
        });

        // Close modal when X is clicked
        closeBtn.addEventListener('click', function() {
            modal.classList.remove('show');
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.classList.remove('show');
            }
        });
    });
</script>
<script>
    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    const closeDeleteBtn = document.querySelector('.close-delete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const applicationsWarning = document.getElementById('applicationsWarning');
    const applicationCount = document.getElementById('applicationCount');

    // Open delete modal when delete button is clicked
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const platformId = this.dataset.platformId;
            const platformName = this.dataset.platformName;

            // Set form action to delete route
            deleteForm.action = `/platforms/${platformId}/delete`;

            // Update message with platform name
            document.getElementById('deleteMessage').textContent = 
                `Are you sure you want to delete "${platformName}"?`;

            // Check for linked applications
            fetch(`/platforms/${platformId}/check_applications`)
                .then(response => response.json())
                .then(data => {
                    if (data.count > 0) {
                        applicationCount.textContent = data.count;
                        applicationsWarning.style.display = 'block';
                    } else {
                        applicationsWarning.style.display = 'none';
                    }
                });

            // Show modal
            deleteModal.classList.add('show');
        });
    });

    // Close delete modal
    closeDeleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('show');
    });

    cancelDeleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('show');
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === deleteModal) {
            deleteModal.classList.remove('show');
        }
    });
</script>
<script>
    const platformNameInput = document.getElementById('platform_name');
    const platformUrlInput = document.getElementById('platform_url');
    const createPlatformBtn = document.getElementById('createPlatformBtn');
    
    function validateCreateForm() {
        const nameValue = platformNameInput.value.trim();
        const urlValue = platformUrlInput.value.trim();
        
        // Enable button only if both fields have text
        if (nameValue.length > 0 && urlValue.length > 0) {
            createPlatformBtn.disabled = false;
        } else {
            createPlatformBtn.disabled = true;
        }
    }
    
    // Add event listeners to both inputs
    platformNameInput.addEventListener('input', validateCreateForm);
    platformUrlInput.addEventListener('input', validateCreateForm);
    
    // Initial validation check
    validateCreateForm();
</script>
{% endblock %}