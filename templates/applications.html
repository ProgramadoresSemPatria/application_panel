{% extends "base.html" %}

{% block title %}Applications - Job Tracker{% endblock %}

{% block content %}
    <div class="platform-box">
        <div class="item-platform">
            <h3 class="box_title">Applications Administration</h3>
            <div class="glass-container">
                <div class="search-container">
                    <div class="search-section">
                        <input type="text" 
                               id="searchInput" 
                               class="search-input" 
                               placeholder="Search applications...">
                    </div>
                    <div class="add-section">
                        <button type="button" id="addApplicationBtn" class="btn-add">
                            <i class="fa-solid fa-plus"></i>
                            Add Application
                        </button>
                    </div>
                </div>
            </div>
            <div class="applications-grid">
                {% for application in applications %}
                <div class="application-card glass-container-application">
                    <!-- Compact header with all 7 fields -->
                    <div class="card-header">
                        <div class="company-section">
                            <h3>{{application.company}}</h3>
                            <span class="role">{{application.role}}</span>
                        </div>
                        <div class="info-section">
                            <span class="date">{{application.application_date}}</span>
                            <span class="platform">{{application.platform_id}}</span>
                            <span class="step-badge status-{{application.last_step}}">Step {{application.last_step}}</span>
                            <span class="feedback">{{application.feedback_id}}</span>
                            <span class="salary">${{application.expected_salary}}</span>
                        </div>
                        <div class="actions-section">
                            <i class="fa-solid fa-pen-to-square edit-btn"></i>
                            <i class="fa-solid fa-trash delete-btn"></i>
                            <button class="btn-expand-mini" title="Show details">
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Additional details (hidden by default) -->
                    <div class="card-details" id="details-{{application.id}}" style="display: none;">
                        <div class="details-grid">
                            <span><strong>Range:</strong> ${{application.salary_range_min}} - ${{application.salary_range_max}}</span>
                            <span><strong>Offer:</strong> ${{application.salary_offer or 'N/A'}}</span>
                            <span><strong>Mode:</strong> {{application.mode}}</span>
                            <span><strong>Last Update:</strong> {{application.last_step_date}}</span>
                            <span><strong>Feedback Date:</strong> {{application.feedback_date}}</span>
                        </div>
                        {% if application.observation %}
                        <div class="observation">
                            <strong>Note:</strong> {{application.observation}}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="addApplicationModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Add New Application</h3>
                <span class="close-add">&times;</span>
            </div>
            <form id="addApplicationForm" method="post" action="{{ url_for('applications') }}" class="form_applications">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" name="company" placeholder="Company" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="role" placeholder="Role" class="form-input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="date" name="application_date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <select name="platform_id" class="form-input" required>
                            <option value="">Select Platform</option>
                            {% for platform in platforms %}
                            <option value="{{platform.id}}">{{platform.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="number" name="expected_salary" placeholder="Expected Salary" class="form-input">
                    </div>
                    <div class="form-group">
                        <select name="mode" class="form-input" required>
                            <option value="">Select Mode</option>
                            <option value="active">Active</option>
                            <option value="passive">Passive</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <textarea name="observation" placeholder="Observation (optional)" class="form-input" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary">Create Application</button>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Edit Platform</h3>
                <span class="close">&times;</span>
            </div>
            <form id="editForm" method="post" class="form_platforms">
                <input type="text" id="edit_platform_name" name="platform_name" placeholder="Platform Name" class="form-input" required>
                <input type="text" id="edit_platform_url" name="platform_url" placeholder="Platform URL" class="form-input" required>
                <button type="submit" class="btn-primary">Update Platform</button>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Delete Platform</h3>
                <span class="close-delete">&times;</span>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this platform?</p>
                <div id="applicationsWarning" class="warning-message" style="display: none;">
                    <strong>Warning:</strong> This will also delete <span id="applicationCount"></span> application(s) linked to this platform.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelDelete">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const addApplicationBtn = document.getElementById('addApplicationBtn');
    const addApplicationModal = document.getElementById('addApplicationModal');
    const closeAddBtn = document.querySelector('.close-add');
    const applicationCards = document.querySelectorAll('.application-card');
    const applicationsGrid = document.querySelector('.applications-grid');
    
    // Create "no results" message
    const noResultsDiv = document.createElement('div');
    noResultsDiv.className = 'no-results';
    noResultsDiv.textContent = 'No applications found matching your search.';
    noResultsDiv.style.display = 'none';
    applicationsGrid.appendChild(noResultsDiv);
    
    // Search functionality
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let visibleCards = 0;
        
        applicationCards.forEach(card => {
            const company = card.querySelector('.company-section h3').textContent.toLowerCase();
            const role = card.querySelector('.company-section .role').textContent.toLowerCase();
            const date = card.querySelector('.date').textContent.toLowerCase();
            const platform = card.querySelector('.platform').textContent.toLowerCase();
            const step = card.querySelector('.step-badge').textContent.toLowerCase();
            const feedback = card.querySelector('.feedback').textContent.toLowerCase();
            const salary = card.querySelector('.salary').textContent.toLowerCase();
            
            const matches = company.includes(searchTerm) || 
                           role.includes(searchTerm) || 
                           date.includes(searchTerm) || 
                           platform.includes(searchTerm) || 
                           step.includes(searchTerm) || 
                           feedback.includes(searchTerm) || 
                           salary.includes(searchTerm);
            
            if (matches || searchTerm === '') {
                card.style.display = '';
                visibleCards++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCards === 0 && searchTerm !== '') {
            noResultsDiv.style.display = 'block';
        } else {
            noResultsDiv.style.display = 'none';
        }
    }
    
    // Search events
    searchInput.addEventListener('input', performSearch);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Add application modal
    addApplicationBtn.addEventListener('click', function() {
        addApplicationModal.classList.add('show');
    });
    
    closeAddBtn.addEventListener('click', function() {
        addApplicationModal.classList.remove('show');
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === addApplicationModal) {
            addApplicationModal.classList.remove('show');
        }
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Adiciona evento de clique para todos os botões de expandir
    document.querySelectorAll('.btn-expand-mini').forEach(button => {
        button.addEventListener('click', function() {
            // Encontra o card pai
            const card = this.closest('.application-card');
            const details = card.querySelector('.card-details');
            const icon = this.querySelector('i');
            
            if (details.style.display === 'none' || details.style.display === '') {
                // Mostra detalhes
                details.style.display = 'block';
                icon.className = 'fa-solid fa-chevron-up';
                this.title = 'Hide details';
            } else {
                // Esconde detalhes
                details.style.display = 'none';
                icon.className = 'fa-solid fa-chevron-down';
                this.title = 'Show details';
            }
        });
    });
});
</script>
<script>
    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    const closeDeleteBtn = document.querySelector('.close-delete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const applicationsWarning = document.getElementById('applicationsWarning');
    const applicationCount = document.getElementById('applicationCount');

    // Open delete modal when delete button is clicked
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const platformId = this.dataset.platformId;
            const platformName = this.dataset.platformName;

            // Set form action to delete route
            deleteForm.action = `/platforms/${platformId}/delete`;

            // Update message with platform name
            document.getElementById('deleteMessage').textContent = 
                `Are you sure you want to delete "${platformName}"?`;

            // Check for linked applications
            fetch(`/platforms/${platformId}/check_applications`)
                .then(response => response.json())
                .then(data => {
                    if (data.count > 0) {
                        applicationCount.textContent = data.count;
                        applicationsWarning.style.display = 'block';
                    } else {
                        applicationsWarning.style.display = 'none';
                    }
                });

            // Show modal
            deleteModal.classList.add('show');
        });
    });

    // Close delete modal
    closeDeleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('show');
    });

    cancelDeleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('show');
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === deleteModal) {
            deleteModal.classList.remove('show');
        }
    });
</script>
<script>
    const platformNameInput = document.getElementById('platform_name');
    const platformUrlInput = document.getElementById('platform_url');
    const createPlatformBtn = document.getElementById('createPlatformBtn');

    function validateCreateForm() {
        const nameValue = platformNameInput.value.trim();
        const urlValue = platformUrlInput.value.trim();

        // Enable button only if both fields have text
        if (nameValue.length > 0 && urlValue.length > 0) {
            createPlatformBtn.disabled = false;
        } else {
            createPlatformBtn.disabled = true;
        }
    }

    // Add event listeners to both inputs
    platformNameInput.addEventListener('input', validateCreateForm);
    platformUrlInput.addEventListener('input', validateCreateForm);

    // Initial validation check
    validateCreateForm();
</script>
{% endblock %}