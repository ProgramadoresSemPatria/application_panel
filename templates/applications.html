<!--
================================================================================
JOB APPLICATION TRACKER - APPLICATIONS MANAGEMENT TEMPLATE
================================================================================
This template provides comprehensive job application management functionality.
It displays applications in a card-based layout with detailed information,
search capabilities, and full CRUD operations for applications and their steps.

Features:
- Responsive card-based application display
- Real-time search across all application fields
- Add, edit, delete applications
- Timeline view with step management
- Add, edit, delete individual steps
- Finalize applications (offer/denial)
- Modal-based interfaces for all operations
- Expandable details for each application

Data Dependencies:
- applications: List of all applications with related data
- platforms: Available job platforms
- steps_definition: Available process steps
- feedbacks_definition: Available feedback types

Modals:
- Add Application Modal
- Edit Application Modal
- Delete Application Modal
- Add Step Modal
- Edit Step Modal
- Delete Step Modal
- Finalize Application Modal
================================================================================
-->

{% extends "base.html" %}

{% block title %}Applications - Job Tracker{% endblock %}

{% block content %}
<div class="platform-box">
    <div class="item-platform">
        <!-- 
        ====================================================================
        PAGE HEADER
        ====================================================================
        Main page title for application management
        ====================================================================
        -->
        <h3 class="box_title">Applications Administration</h3>
        
        <!-- 
        ====================================================================
        SEARCH AND ADD SECTION
        ====================================================================
        Top control bar with search functionality and add application button.
        Allows users to search across all application fields and create new
        applications via modal interface.
        ====================================================================
        -->
        <div class="glass-container">
            <div class="search-container">
                <!-- Search Input Section -->
                <div class="search-section">
                    <input type="text" 
                           id="searchInput" 
                           class="search-input" 
                           placeholder="Search applications...">
                </div>
                
                <!-- Add New Application Button -->
                <div class="add-section">
                    <button type="button" id="addApplicationBtn" class="btn-add">
                        <i class="fa-solid fa-plus"></i>
                        Add Application
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 
        ====================================================================
        APPLICATIONS GRID
        ====================================================================
        Main content area displaying all applications in a responsive grid.
        Each application is displayed as a card with expandable details.
        ====================================================================
        -->
        <div class="applications-grid">
            {% for application in applications %}
            <!-- 
            ================================================================
            APPLICATION CARD
            ================================================================
            Individual application card with compact header and expandable
            details. Contains all application information and action buttons.
            ================================================================
            -->
            <div class="application-card glass-container-application">
                
                <!-- 
                ============================================================
                CARD HEADER - COMPACT VIEW
                ============================================================
                Main information displayed by default: company, role, date,
                platform, status, feedback, salary range, and action buttons.
                ============================================================
                -->
                <div class="card-header">
                    <!-- Company and Role Section -->
                    <div class="company-section">
                        <h3>{{ application.company }}</h3>
                        <span class="role">{{ application.role }}</span>
                    </div>
                    
                    <!-- Information Section with 6 data fields -->
                    <div class="info-section">
                        <!-- Application Date -->
                        <span class="date">{{ application.application_date }}</span>
                        
                        <!-- Platform Badge -->
                        <span class="platform" data-label="Platform">
                            {{ application.platform_name }}
                        </span>
                        
                        <!-- Current Step Badge with Dynamic Color -->
                        <span class="step-badge" 
                              data-label="Status" 
                              style="background-color: {{ application.step_color }}33; 
                                     color: {{ application.step_color }}; 
                                     border: 1px solid {{ application.step_color }}55;">
                            {{ application.step_name }}
                        </span>
                        
                        <!-- Feedback Badge with Dynamic Color -->
                        <span class="feedback" 
                              data-label="Feedback" 
                              style="background-color: {{ application.feedback_color }}33; 
                                     color: {{ application.feedback_color }}; 
                                     border: 1px solid {{ application.feedback_color }}55;">
                            {{ application.feedback_name }}
                        </span>
                        
                        <!-- Salary Range Display -->
                        <span class="salary" data-label="Range Salary">
                            ${{ application.salary_range_min }}k - ${{ application.salary_range_max }}k
                        </span>
                    </div>
                    
                    <!-- 
                    ========================================================
                    ACTIONS SECTION
                    ========================================================
                    Action buttons for application management operations.
                    Each button contains data attributes for modal population.
                    ========================================================
                    -->
                    <div class="actions-section">
                        <!-- Add Step Button -->
                        <i class="fa-solid fa-plus add-step-btn" 
                           title="Add Step"
                           data-application-id="{{ application.id }}"
                           data-application-company="{{ application.company }}"
                           data-application-role="{{ application.role }}"></i>
                        
                        <!-- Finalize Application Button -->
                        <i class="fa-solid fa-flag-checkered finalize-btn" 
                           title="Finalize Application"
                           data-application-id="{{ application.id }}"
                           data-application-company="{{ application.company }}"
                           data-application-role="{{ application.role }}"></i>
                        
                        <!-- Edit Application Button with Full Data -->
                        <i class="fa-solid fa-pen-to-square edit-btn"
                           title="Edit Application"
                           data-application-id="{{ application.id }}"
                           data-company="{{ application.company }}"
                           data-role="{{ application.role }}"
                           data-application-date="{{ application.application_date }}"
                           data-platform-id="{{ application.platform_id }}"
                           data-mode="{{ application.mode }}"
                           data-expected-salary="{{ application.expected_salary }}"
                           data-salary-range-min="{{ application.salary_range_min }}"
                           data-salary-range-max="{{ application.salary_range_max }}"
                           data-observation="{{ application.observation }}"></i>
                        
                        <!-- Delete Application Button -->
                        <i class="fa-solid fa-trash delete-btn"
                           title="Delete Application"
                           data-application-id="{{ application.id }}"
                           data-application-company="{{ application.company }}"
                           data-application-role="{{ application.role }}"></i>
                        
                        <!-- Expand/Collapse Details Button -->
                        <button class="btn-expand-mini" title="Show details">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 
                ============================================================
                CARD DETAILS - EXPANDABLE VIEW
                ============================================================
                Additional application information shown when expanded.
                Includes full details grid, observations, and step timeline.
                ============================================================
                -->
                <div class="card-details" id="details-{{ application.id }}" style="display: none;">
                    
                    <!-- Detailed Information Grid -->
                    <div class="details-grid">
                        <!-- Expected Salary -->
                        <span><strong>Salary Expected:</strong> ${{ application.expected_salary }}k</span>
                        
                        <!-- Salary Offer (if available) -->
                        <span><strong>Salary Offer:</strong> 
                            {% if application.salary_offer %}
                                ${{ application.salary_offer }}k
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                        
                        <!-- Work Mode -->
                        <span><strong>Mode:</strong> {{ application.mode|title }}</span>
                        
                        <!-- Last Step Update Date -->
                        <span><strong>Step Update:</strong> {{ application.last_step_date }}</span>
                        
                        <!-- Feedback Date -->
                        <span><strong>Feedback Date:</strong> {{ application.feedback_date }}</span>
                    </div>
                    
                    <!-- Application Observation (if exists) -->
                    {% if application.observation %}
                    <div class="observation">
                        <strong>Note:</strong> {{ application.observation }}
                    </div>
                    {% endif %}
                    
                    <!-- 
                    ====================================================
                    APPLICATION TIMELINE
                    ====================================================
                    Visual timeline showing all steps in the application
                    process with dates and observations.
                    ====================================================
                    -->
                    <div class="steps-timeline">
                        <h4 class="timeline-title">
                            <i class="fa-solid fa-clock"></i>
                            Application Timeline
                        </h4>
                        
                        <!-- Timeline Content (if steps exist) -->
                        {% if application.steps %}
                        <div class="timeline-container">
                            {% for step in application.steps %}
                            <div class="timeline-item">
                                <!-- Timeline Marker with Step Color -->
                                <div class="timeline-marker" 
                                     style="background-color: {{ step.step_color }}33; 
                                            border-color: {{ step.step_color }};"></div>
                                <div class="timeline-line"></div>
                                
                                <!-- Timeline Content Box -->
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <!-- Step Name -->
                                        <span class="timeline-step-name">{{ step.step_name }}</span>
                                        
                                        <!-- Date and Action Buttons -->
                                        <div class="actions-date-section">
                                            <span class="timeline-date">{{ step.step_date }}</span>
                                            
                                            <!-- Edit Step Button -->
                                            <i class="fa-solid fa-pen-to-square edit-step-btn steps_app_ins"
                                               data-step-id="{{ step.id }}"
                                               data-step-step-id="{{ step.step_id }}"
                                               data-step-name="{{ step.step_name }}"
                                               data-step-date="{{ step.step_date }}"
                                               data-step-observation="{{ step.observation }}"
                                               data-application-id="{{ application.id }}"
                                               title="Edit Step"></i>
                                            
                                            <!-- Delete Step Button -->
                                            <i class="fa-solid fa-trash delete-step-btn steps_app_ins"
                                               data-step-id="{{ step.id }}"
                                               data-step-name="{{ step.step_name }}"
                                               data-step-date="{{ step.step_date }}"
                                               data-application-id="{{ application.id }}"
                                               title="Delete Step"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- Step Observation (if exists) -->
                                    {% if step.observation %}
                                    <div class="timeline-observation">{{ step.observation }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- No Steps Message -->
                        {% else %}
                        <div class="no-timeline">
                            <i class="fa-solid fa-info-circle"></i>
                            <span>No steps recorded yet</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!--
================================================================================
MODAL INTERFACES
================================================================================
All modal dialogs for application and step management operations.
Each modal includes proper form handling and data validation.
================================================================================
-->

<!-- 
====================================================================
ADD APPLICATION MODAL
====================================================================
Modal for creating new job applications with all required fields.
====================================================================
-->
<div id="addApplicationModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Add New Application</h3>
            <span class="close-add">&times;</span>
        </div>
        
        <form id="addApplicationForm" method="post" action="{{ url_for('applications') }}" class="form_applications">
            <div class="modal-body">
                <!-- Company and Role Row -->
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" 
                               name="company" 
                               placeholder="Company (required)" 
                               class="form-input-application" 
                               required>
                    </div>
                    <div class="form-group">
                        <input type="text" 
                               name="role" 
                               placeholder="Role (required)" 
                               class="form-input-application" 
                               required>
                    </div>
                </div>
                
                <!-- Date and Platform Row -->
                <div class="form-row">
                    <div class="form-group">
                        <input type="date" 
                               name="application_date" 
                               class="form-input-application" 
                               required>
                    </div>
                    <div class="form-group">
                        <select name="platform_id" class="form-input-application" required>
                            <option value="">Select Platform (required)</option>
                            {% for platform in platforms %}
                            <option value="{{ platform.id }}">{{ platform.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Mode and Expected Salary Row -->
                <div class="form-row">
                    <div class="form-group">
                        <select name="mode" class="form-input-application" required>
                            <option value="">Select Mode (required)</option>
                            <option value="active">Active</option>
                            <option value="passive">Passive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" 
                               name="expected_salary" 
                               placeholder="Expected Salary (optional)" 
                               class="form-input-application">
                    </div>
                </div>
                
                <!-- Salary Range Row -->
                <div class="form-row">
                    <div class="form-group">
                        <input type="number" 
                               name="salary_range_min" 
                               placeholder="Salary Range Min (optional)" 
                               class="form-input-application">
                    </div>
                    <div class="form-group">
                        <input type="number" 
                               name="salary_range_max" 
                               placeholder="Salary Range Max (optional)" 
                               class="form-input-application">
                    </div>
                </div>
                
                <!-- Observation Field -->
                <div class="form-group">
                    <textarea name="observation" 
                              placeholder="Observation (optional)" 
                              class="form-input-observation" 
                              rows="3"></textarea>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="submit" class="btn-primary">Create Application</button>
            </div>
        </form>
    </div>
</div>

<!-- 
====================================================================
ADD STEP MODAL
====================================================================
Modal for adding new steps to existing applications.
====================================================================
-->
<div id="addStepModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Add Step</h3>
            <span class="close-step">&times;</span>
        </div>
        
        <form id="addStepForm" method="post" class="form_applications">
            <!-- Application Information Display -->
            <p id="stepApplicationInfo"></p>
            
            <div class="modal-body">
                <!-- Step and Date Row -->
                <div class="form-row">
                    <div class="form-group">
                        <select name="step_id" class="form-input-application" required>
                            <option value="">Select Step</option>
                            {% for step in steps_definition %}
                            <option value="{{ step.id }}">{{ step.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="date" 
                               name="step_date" 
                               class="form-input-application" 
                               required>
                    </div>
                </div>
                
                <!-- Step Observation -->
                <div class="form-group">
                    <textarea name="observation" 
                              placeholder="Step details (optional)" 
                              class="form-input-observation" 
                              rows="3"></textarea>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="submit" class="btn-primary">Add Step</button>
            </div>
        </form>
    </div>
</div>

<!-- 
====================================================================
FINALIZE APPLICATION MODAL
====================================================================
Modal for finalizing applications with offer or denial outcome.
====================================================================
-->
<div id="finalizeModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Finalize Application</h3>
            <span class="close-finalize">&times;</span>
        </div>
        
        <form id="finalizeForm" method="post" class="form_applications">
            <!-- Application Information Display -->
            <p id="finalizeApplicationInfo"></p>
            
            <div class="modal-body">
                <!-- Result and Feedback Row -->
                <div class="form-row">
                    <div class="form-group">
                        <select name="final_step" class="form-input-application" required>
                            <option value="">Select Result</option>
                            <option value="6">Offer</option>
                            <option value="7">Denied</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select name="feedback_id" class="form-input-application" required>
                            <option value="">Select Feedback</option>
                            {% for feedback in feedbacks_definition %}
                            <option value="{{ feedback.id }}">{{ feedback.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Date and Salary Offer Row -->
                <div class="form-row">
                    <div class="form-group">
                        <input type="date" 
                               name="finalize_date" 
                               class="form-input-application" 
                               required>
                    </div>
                    <!-- Salary Offer Field (shown only for offers) -->
                    <div class="form-group" id="salaryOfferGroup" style="display: none;">
                        <input type="number" 
                               name="salary_offer" 
                               placeholder="Salary offer amount" 
                               class="form-input-application">
                    </div>
                </div>
                
                <!-- Final Observation -->
                <div class="form-group">
                    <textarea name="final_observation" 
                              placeholder="Final notes about the application" 
                              class="form-input-observation" 
                              rows="3"></textarea>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="submit" class="btn-danger" id="finalizeSubmit">
                    Finalize Application
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 
====================================================================
EDIT APPLICATION MODAL
====================================================================
Modal for editing existing application information.
====================================================================
-->
<div id="editModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Edit Applications</h3>
            <span class="close">&times;</span>
        </div>
        
        <form id="editForm" method="post" class="form_applications">
            <!-- Company and Role Row -->
            <div class="form-row">
                <div class="form-group">
                    <input type="text" 
                           id="edit_company" 
                           name="company" 
                           placeholder="Company (required)" 
                           class="form-input-application" 
                           required>
                </div>
                <div class="form-group">
                    <input type="text" 
                           id="edit_role" 
                           name="role" 
                           placeholder="Role (required)" 
                           class="form-input-application" 
                           required>
                </div>
            </div>
            
            <!-- Date and Platform Row -->
            <div class="form-row">
                <div class="form-group">
                    <input type="date" 
                           id="edit_application_date" 
                           name="application_date" 
                           class="form-input-application" 
                           required>
                </div>
                <div class="form-group">
                    <select id="edit_platform_id" 
                            name="platform_id" 
                            class="form-input-application" 
                            required>
                        <option value="">Select Platform (required)</option>
                        {% for platform in platforms %}
                        <option value="{{ platform.id }}">{{ platform.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Mode and Expected Salary Row -->
            <div class="form-row">
                <div class="form-group">
                    <select id="edit_mode" 
                            name="mode" 
                            class="form-input-application" 
                            required>
                        <option value="">Select Mode (required)</option>
                        <option value="active">Active</option>
                        <option value="passive">Passive</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" 
                           id="edit_expected_salary" 
                           name="expected_salary" 
                           placeholder="Expected Salary (optional)" 
                           class="form-input-application">
                </div>
            </div>
            
            <!-- Salary Range Row -->
            <div class="form-row">
                <div class="form-group">
                    <input type="number" 
                           id="edit_salary_range_min" 
                           name="salary_range_min" 
                           placeholder="Salary Range Min (optional)" 
                           class="form-input-application">
                </div>
                <div class="form-group">
                    <input type="number" 
                           id="edit_salary_range_max" 
                           name="salary_range_max" 
                           placeholder="Salary Range Max (optional)" 
                           class="form-input-application">
                </div>
            </div>
            
            <!-- Observation Field -->
            <div class="form-group">
                <textarea id="edit_observation" 
                          name="observation" 
                          placeholder="Observation (optional)" 
                          class="form-input-observation" 
                          rows="3"></textarea>
            </div>
            
            <div class="modal-footer">
                <button type="submit" class="btn-primary">Update Application</button>
            </div>
        </form>
    </div>
</div>

<!-- 
====================================================================
DELETE APPLICATION MODAL
====================================================================
Confirmation modal for deleting applications.
====================================================================
-->
<div id="deleteModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Delete Application</h3>
            <span class="close-delete">&times;</span>
        </div>
        
        <div class="modal-body">
            <p id="deleteMessage">Are you sure you want to delete this application?</p>
        </div>
        
        <div class="modal-footer">
            <form id="deleteForm" method="post" style="display: inline;">
                <button type="submit" class="btn-danger">Delete</button>
            </form>
        </div>
    </div>
</div>

<!-- 
====================================================================
EDIT STEP MODAL
====================================================================
Modal for editing individual application steps.
====================================================================
-->
<div id="editStepModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Edit Step</h3>
            <span class="close-step-edit">&times;</span>
        </div>
        
        <form id="editStepForm" method="post" class="form_steps">
            <div class="modal-body">
                <!-- Step and Date Row -->
                <div class="form-row">
                    <div class="form-group">
                        <select id="edit_step_id" 
                                name="step_id" 
                                class="form-input-application" 
                                required>
                            <option value="">Select Step</option>
                            {% for step in steps_definition %}
                            <option value="{{ step.id }}">{{ step.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="date" 
                               id="edit_step_date" 
                               name="step_date" 
                               class="form-input-application" 
                               required>
                    </div>
                </div>
                
                <!-- Step Observation -->
                <div class="form-group">
                    <textarea id="edit_step_observation" 
                              name="observation" 
                              placeholder="Optional observation" 
                              class="form-input-observation" 
                              rows="3"></textarea>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="submit" class="btn-primary">Update Step</button>
            </div>
        </form>
    </div>
</div>

<!-- 
====================================================================
DELETE STEP MODAL
====================================================================
Confirmation modal for deleting individual steps.
====================================================================
-->
<div id="deleteStepModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Delete Step</h3>
            <span class="close-step-delete">&times;</span>
        </div>
        
        <div class="modal-body">
            <p>Are you sure you want to delete this step?</p>
            <div class="step-info">
                <strong>Step:</strong> <span id="delete_step_name_display"></span><br>
                <strong>Date:</strong> <span id="delete_step_date_display"></span>
            </div>
        </div>
        
        <div class="modal-footer">
            <button id="confirmDeleteStep" class="btn-danger">Delete Step</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!--
================================================================================
JAVASCRIPT FUNCTIONALITY
================================================================================
All JavaScript code for handling interactive features including:
- Search functionality
- Modal management
- Form handling
- Dynamic UI updates
- CRUD operations for applications and steps
================================================================================
-->

<script>
/**
 * SEARCH AND ADD APPLICATION FUNCTIONALITY
 * ========================================
 * Handles the search input filtering and add application modal.
 * Provides real-time search across all application fields.
 */
document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const searchInput = document.getElementById('searchInput');
    const addApplicationBtn = document.getElementById('addApplicationBtn');
    const addApplicationModal = document.getElementById('addApplicationModal');
    const closeAddBtn = document.querySelector('.close-add');
    const applicationCards = document.querySelectorAll('.application-card');
    const applicationsGrid = document.querySelector('.applications-grid');
    
    // Create "no results" message element
    const noResultsDiv = document.createElement('div');
    noResultsDiv.className = 'no-results';
    noResultsDiv.textContent = 'No applications found matching your search.';
    noResultsDiv.style.display = 'none';
    applicationsGrid.appendChild(noResultsDiv);
    
    /**
     * Search Functionality
     * Filters applications based on search term across multiple fields
     */
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let visibleCards = 0;
        
        applicationCards.forEach(card => {
            // Extract searchable text from each application card
            const company = card.querySelector('.company-section h3').textContent.toLowerCase();
            const role = card.querySelector('.company-section .role').textContent.toLowerCase();
            const date = card.querySelector('.date').textContent.toLowerCase();
            const platform = card.querySelector('.platform').textContent.toLowerCase();
            const step = card.querySelector('.step-badge').textContent.toLowerCase();
            const feedback = card.querySelector('.feedback').textContent.toLowerCase();
            const salary = card.querySelector('.salary').textContent.toLowerCase();
            
            // Check if search term matches any field
            const matches = company.includes(searchTerm) || 
                           role.includes(searchTerm) || 
                           date.includes(searchTerm) || 
                           platform.includes(searchTerm) || 
                           step.includes(searchTerm) || 
                           feedback.includes(searchTerm) || 
                           salary.includes(searchTerm);
            
            // Show/hide card based on match
            if (matches || searchTerm === '') {
                card.style.display = '';
                visibleCards++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCards === 0 && searchTerm !== '') {
            noResultsDiv.style.display = 'block';
        } else {
            noResultsDiv.style.display = 'none';
        }
    }
    
    // Search event listeners
    searchInput.addEventListener('input', performSearch);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Add application modal events
    addApplicationBtn.addEventListener('click', function() {
        addApplicationModal.classList.add('show');
    });
    
    closeAddBtn.addEventListener('click', function() {
        addApplicationModal.classList.remove('show');
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === addApplicationModal) {
            addApplicationModal.classList.remove('show');
        }
    });
});
</script>

<script>
/**
 * CARD EXPAND/COLLAPSE FUNCTIONALITY
 * ==================================
 * Handles the expand/collapse behavior for application detail views.
 * Toggles visibility of additional information and timeline.
 */
document.addEventListener('DOMContentLoaded', function() {
    // Add click event listeners to all expand buttons
    document.querySelectorAll('.btn-expand-mini').forEach(button => {
        button.addEventListener('click', function() {
            // Find parent card and details section
            const card = this.closest('.application-card');
            const details = card.querySelector('.card-details');
            const icon = this.querySelector('i');
            
            // Toggle details visibility
            if (details.style.display === 'none' || details.style.display === '') {
                // Show details
                details.style.display = 'block';
                icon.className = 'fa-solid fa-chevron-up';
                this.title = 'Hide details';
            } else {
                // Hide details
                details.style.display = 'none';
                icon.className = 'fa-solid fa-chevron-down';
                this.title = 'Show details';
            }
        });
    });
});
</script>

<script>
/**
 * ADD STEP AND FINALIZE APPLICATION FUNCTIONALITY
 * ===============================================
 * Handles the add step and finalize application modals.
 * Manages form population, validation, and dynamic UI updates.
 */
document.addEventListener('DOMContentLoaded', function() {
    // Modal elements
    const addStepModal = document.getElementById('addStepModal');
    const finalizeModal = document.getElementById('finalizeModal');
    const addStepForm = document.getElementById('addStepForm');
    const finalizeForm = document.getElementById('finalizeForm');
    
    // Button elements
    const addStepButtons = document.querySelectorAll('.add-step-btn');
    const finalizeButtons = document.querySelectorAll('.finalize-btn');
    
    // Close button elements
    const closeStepBtn = document.querySelector('.close-step');
    const closeFinalizeBtn = document.querySelector('.close-finalize');
    
    /**
     * Add Step Modal Handler
     * Opens modal and populates form with application data
     */
    addStepButtons.forEach(button => {
        button.addEventListener('click', function() {
            const applicationId = this.dataset.applicationId;
            const applicationCompany = this.dataset.applicationCompany;
            const applicationRole = this.dataset.applicationRole;
            
            // Set form action URL
            addStepForm.action = `/applications/${applicationId}/add-step`;
            
            // Update modal info text
            document.getElementById('stepApplicationInfo').textContent = 
                `Adding step for: ${applicationRole} at ${applicationCompany}`;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="step_date"]').value = today;
            
            // Show modal
            addStepModal.classList.add('show');
        });
    });
    
    /**
     * Finalize Application Modal Handler
     * Opens modal and sets up form for application finalization
     */
    finalizeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const applicationId = this.dataset.applicationId;
            const applicationCompany = this.dataset.applicationCompany;
            const applicationRole = this.dataset.applicationRole;
            
            // Set form action URL
            finalizeForm.action = `/applications/${applicationId}/finalize`;
            
            // Update modal info text
            document.getElementById('finalizeApplicationInfo').textContent = 
                `Finalizing: ${applicationRole} at ${applicationCompany}`;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="finalize_date"]').value = today;
            
            // Show modal
            finalizeModal.classList.add('show');
        });
    });
    
    /**
     * Dynamic Salary Offer Field Visibility
     * Shows/hides salary offer field based on final result selection
     */
    const finalStepSelect = document.querySelector('select[name="final_step"]');
    const salaryOfferGroup = document.getElementById('salaryOfferGroup');
    const finalizeSubmit = document.getElementById('finalizeSubmit');
    
    finalStepSelect.addEventListener('change', function() {
        if (this.value === '6') { // Offer selected
            salaryOfferGroup.style.display = 'flex';
            finalizeSubmit.textContent = 'Finalize Application';
            finalizeSubmit.className = 'btn-primary';
        } else if (this.value === '7') { // Denied selected
            salaryOfferGroup.style.display = 'none';
            finalizeSubmit.textContent = 'Mark as Denied';
            finalizeSubmit.className = 'btn-danger';
        } else {
            salaryOfferGroup.style.display = 'none';
            finalizeSubmit.textContent = 'Finalize Application';
            finalizeSubmit.className = 'btn-danger';
        }
    });
    
    // Modal close event handlers
    closeStepBtn.addEventListener('click', () => addStepModal.classList.remove('show'));
    closeFinalizeBtn.addEventListener('click', () => finalizeModal.classList.remove('show'));
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === addStepModal) {
            addStepModal.classList.remove('show');
        }
        if (event.target === finalizeModal) {
            finalizeModal.classList.remove('show');
        }
    });
});
</script>

<script>
/**
 * EDIT APPLICATION FUNCTIONALITY
 * ==============================
 * Handles the edit application modal, form population, and submission.
 * Populates form fields with existing application data.
 */
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const closeBtn = document.querySelector('.close');
    const editButtons = document.querySelectorAll('.edit-btn');

    /**
     * Edit Application Modal Handler
     * Opens modal and populates form with current application data
     */
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Extract all application data from button attributes
            const applicationId = this.dataset.applicationId;
            const company = this.dataset.company;
            const role = this.dataset.role;
            const applicationDate = this.dataset.applicationDate;
            const platformId = this.dataset.platformId;
            const mode = this.dataset.mode;
            const expectedSalary = this.dataset.expectedSalary;
            const salaryRangeMin = this.dataset.salaryRangeMin;
            const salaryRangeMax = this.dataset.salaryRangeMax;
            const observation = this.dataset.observation;

            // Set form action to update route
            editForm.action = `/applications/${applicationId}/update`;

            // Populate all form fields with current data
            document.getElementById('edit_company').value = company || '';
            document.getElementById('edit_role').value = role || '';
            document.getElementById('edit_application_date').value = applicationDate || '';
            document.getElementById('edit_platform_id').value = platformId || '';
            document.getElementById('edit_mode').value = mode || '';
            document.getElementById('edit_expected_salary').value = expectedSalary || '';
            document.getElementById('edit_salary_range_min').value = salaryRangeMin || '';
            document.getElementById('edit_salary_range_max').value = salaryRangeMax || '';
            document.getElementById('edit_observation').value = observation || '';

            // Show modal
            modal.classList.add('show');
        });
    });

    // Modal close event handlers
    closeBtn.addEventListener('click', function() {
        modal.classList.remove('show');
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.classList.remove('show');
        }
    });
});
</script>

<script>
/**
 * DELETE APPLICATION FUNCTIONALITY
 * ================================
 * Handles the delete application confirmation modal.
 * Shows confirmation message with application details.
 */
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    const closeDeleteBtn = document.querySelector('.close-delete');
    const deleteButtons = document.querySelectorAll('.delete-btn');

    /**
     * Delete Application Modal Handler
     * Opens confirmation modal with application details
     */
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const applicationId = this.dataset.applicationId;
            const applicationCompany = this.dataset.applicationCompany;
            const applicationRole = this.dataset.applicationRole;
            
            // Set form action to delete route
            deleteForm.action = `/applications/${applicationId}/delete`;

            // Update confirmation message with specific application info
            document.getElementById('deleteMessage').textContent = 
                `Are you sure you want to delete "${applicationRole} at ${applicationCompany}"?`;
            
            // Show modal
            deleteModal.classList.add('show');
        });
    });

    // Modal close event handlers
    closeDeleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('show');
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === deleteModal) {
            deleteModal.classList.remove('show');
        }
    });
});
</script>

<script>
/**
 * EDIT STEP FUNCTIONALITY
 * =======================
 * Handles editing individual application steps.
 * Populates form with current step data for modification.
 */
document.addEventListener('DOMContentLoaded', function() {
    const editStepModal = document.getElementById('editStepModal');
    const editStepForm = document.getElementById('editStepForm');
    const closeEditStepBtn = document.querySelector('.close-step-edit');
    const editStepButtons = document.querySelectorAll('.edit-step-btn');

    /**
     * Edit Step Modal Handler
     * Opens modal and populates form with current step data
     */
    editStepButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Extract step data from button attributes
            const stepId = this.dataset.stepId;
            const stepStepId = this.dataset.stepStepId;
            const stepDate = this.dataset.stepDate;
            const stepObservation = this.dataset.stepObservation;
            const applicationId = this.dataset.applicationId;

            // Set form action URL
            editStepForm.action = `/applications/${applicationId}/steps/${stepId}/update`;

            // Populate form fields with current step data
            document.getElementById('edit_step_id').value = stepStepId || '';
            document.getElementById('edit_step_date').value = stepDate || '';
            document.getElementById('edit_step_observation').value = stepObservation || '';

            // Show modal
            editStepModal.classList.add('show');
        });
    });

    // Modal close event handlers
    closeEditStepBtn.addEventListener('click', function() {
        editStepModal.classList.remove('show');
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === editStepModal) {
            editStepModal.classList.remove('show');
        }
    });
});
</script>

<script>
/**
 * DELETE STEP FUNCTIONALITY
 * =========================
 * Handles deletion of individual application steps.
 * Shows confirmation modal with step details before deletion.
 */
document.addEventListener('DOMContentLoaded', function() {
    const deleteStepModal = document.getElementById('deleteStepModal');
    const closeDeleteStepBtn = document.querySelector('.close-step-delete');
    const deleteStepButtons = document.querySelectorAll('.delete-step-btn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteStep');
    
    // Variables to store current step information
    let currentStepId = null;
    let currentApplicationId = null;

    /**
     * Delete Step Modal Handler
     * Opens confirmation modal with step details
     */
    deleteStepButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Extract step data from button attributes
            const stepId = this.dataset.stepId;
            const stepName = this.dataset.stepName;
            const stepDate = this.dataset.stepDate;
            const applicationId = this.dataset.applicationId;

            // Store IDs for later use in confirmation
            currentStepId = stepId;
            currentApplicationId = applicationId;

            // Display step information in confirmation modal
            document.getElementById('delete_step_name_display').textContent = stepName;
            document.getElementById('delete_step_date_display').textContent = stepDate;

            // Show modal
            deleteStepModal.classList.add('show');
        });
    });

    // Modal close event handlers
    closeDeleteStepBtn.addEventListener('click', function() {
        deleteStepModal.classList.remove('show');
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === deleteStepModal) {
            deleteStepModal.classList.remove('show');
        }
    });

    /**
     * Confirm Step Deletion
     * Creates and submits a form to delete the selected step
     */
    confirmDeleteBtn.addEventListener('click', function() {
        if (currentStepId && currentApplicationId) {
            // Create a temporary form for step deletion
            const stepDeleteForm = document.createElement('form');
            stepDeleteForm.method = 'POST';
            stepDeleteForm.action = `/applications/${currentApplicationId}/steps/${currentStepId}/delete`;
            
            // Add form to DOM and submit
            document.body.appendChild(stepDeleteForm);
            stepDeleteForm.submit();
        }
    });
});
</script>

{% endblock %}