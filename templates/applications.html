{% extends "base.html" %}

{% block title %}Applications - Job Tracker{% endblock %}

{% block content %}
    <div class="platform-box">
        <div class="item-platform">
            <h3 class="box_title">Applications Administration</h3>
            <div class="glass-container">
                <div class="search-container">
                    <div class="search-section">
                        <input type="text" 
                               id="searchInput" 
                               class="search-input" 
                               placeholder="Search applications...">
                    </div>
                    <div class="add-section">
                        <button type="button" id="addApplicationBtn" class="btn-add">
                            <i class="fa-solid fa-plus"></i>
                            Add Application
                        </button>
                    </div>
                </div>
            </div>
            <div class="applications-grid">
                {% for application in applications %}
                <div class="application-card glass-container-application">
                    <!-- Compact header with all 7 fields -->
                    <div class="card-header">
                        <div class="company-section">
                            <h3>{{application.company}}</h3>
                            <span class="role">{{application.role}}</span>
                        </div>
                        <div class="info-section">
                            <span class="date">{{application.application_date}}</span>
                            <span class="platform" data-label="Platform">{{application.platform_name}}</span>
                            <span class="step-badge" data-label="Status" style="background-color: {{application.step_color}}33; color: {{application.step_color}}; border: 1px solid {{application.step_color}}55;">{{application.step_name}}</span>
                            <span class="feedback" data-label="Feedback" style="background-color: {{application.feedback_color}}33; color: {{application.feedback_color}}; border: 1px solid {{application.feedback_color}}55;">{{application.feedback_name}}</span>
                            <span class="salary" data-label="Range Salary">${{application.salary_range_min}}k - ${{application.salary_range_max}}k</span>
                        </div>
                        <div class="actions-section">
                            <i class="fa-solid fa-plus add-step-btn" 
                               title="Add Step"
                               data-application-id="{{application.id}}"
                               data-application-company="{{application.company}}"
                               data-application-role="{{application.role}}"></i>
                            <i class="fa-solid fa-flag-checkered finalize-btn" 
                               title="Finalize Application"
                               data-application-id="{{application.id}}"
                               data-application-company="{{application.company}}"
                               data-application-role="{{application.role}}"></i>
                            <i class="fa-solid fa-pen-to-square edit-btn"></i>
                            <i class="fa-solid fa-trash delete-btn"
                               data-application-id="{{application.id}}"
                               data-application-company="{{application.company}}"
                               data-application-role="{{application.role}}"></i>
                            <button class="btn-expand-mini" title="Show details">
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Additional details (hidden by default) -->
                    <div class="card-details" id="details-{{application.id}}" style="display: none;">
                        <div class="details-grid">
                            <span><strong>Salary Expected:</strong> ${{application.expected_salary}}k</span>
                            <span><strong>Salary Offer:</strong> {% if application.salary_offer %}
                                                                    ${{application.salary_offer}}k
                                                                 {% else %}
                                                                    N/A
                                                                 {% endif %}</span>
                            <span><strong>Mode:</strong> {{application.mode}}</span>
                            <span><strong>Step Update:</strong> {{application.last_step_date}}</span>
                            <span><strong>Feedback Date:</strong> {{application.feedback_date}}</span>
                        </div>
                        {% if application.observation %}
                        <div class="observation">
                            <strong>Note:</strong> {{application.observation}}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="addApplicationModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Add New Application</h3>
                <span class="close-add">&times;</span>
            </div>
            <form id="addApplicationForm" method="post" action="{{ url_for('applications') }}" class="form_applications">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" name="company" placeholder="Company (required)" class="form-input-application" required>
                    </div>
                    <div class="form-group">
                        <input type="text" name="role" placeholder="Role (required)" class="form-input-application" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="date" name="application_date" class="form-input-application" required>
                    </div>
                    <div class="form-group">
                        <select name="platform_id" class="form-input-application" required>
                            <option value="">Select Platform (required)</option>
                            {% for platform in platforms %}
                            <option value="{{platform.id}}">{{platform.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <select name="mode" class="form-input-application" required>
                            <option value="">Select Mode (required)</option>
                            <option value="active">Active</option>
                            <option value="passive">Passive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" name="expected_salary" placeholder="Expected Salary (optional)" class="form-input-application">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="number" name="salary_range_min" placeholder="Salary Range Min (optional)" class="form-input-application">
                    </div>
                    <div class="form-group">
                        <input type="number" name="salary_range_max" placeholder="Salary Range Max (optional)" class="form-input-application">
                    </div>
                </div>
                <div class="form-group">
                    <textarea name="observation" placeholder="Observation (optional)" class="form-input-observation" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-primary">Create Application</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Step Modal -->
<div id="addStepModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Add Step</h3>
            <span class="close-step">&times;</span>
        </div>
        <form id="addStepForm" method="post" class="form_applications">
            <div class="modal-body">
                <p id="stepApplicationInfo"></p>
                
                <div class="form-group">
                    <label class="form-label required">Step</label>
                    <select name="step_id" class="form-input" required>
                        <option value="">Select Step</option>
                        {% for step in steps_definition %}
                        <option value="{{step.id}}">{{step.name}}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Date</label>
                    <input type="date" name="step_date" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observation</label>
                    <textarea name="observation" placeholder="Step details (optional)" class="form-input" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelAddStep">Cancel</button>
                <button type="submit" class="btn-primary">Add Step</button>
            </div>
        </form>
    </div>
</div>

<!-- Finalize Application Modal -->
<div id="finalizeModal" class="modal">
    <div class="modal-content glass-container">
        <div class="modal-header">
            <h3>Finalize Application</h3>
            <span class="close-finalize">&times;</span>
        </div>
        <form id="finalizeForm" method="post" class="form_applications">
            <div class="modal-body">
                <p id="finalizeApplicationInfo"></p>
                
                <div class="form-group">
                    <label class="form-label required">Final Result</label>
                    <select name="final_step" class="form-input" required>
                        <option value="">Select Result</option>
                        <option value="7">Offer</option>
                        <option value="8">Denied</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Feedback</label>
                    <select name="feedback_id" class="form-input" required>
                        <option value="">Select Feedback</option>
                        {% for feedback in feedbacks_definition %}
                        <option value="{{feedback.id}}">{{feedback.name}}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" name="finalize_date" class="form-input" required>
                </div>
                
                <div class="form-group" id="salaryOfferGroup" style="display: none;">
                    <label class="form-label">Salary Offer</label>
                    <input type="number" name="salary_offer" placeholder="Salary offer amount" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Final Notes</label>
                    <textarea name="final_observation" placeholder="Final notes about the application" class="form-input" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelFinalize">Cancel</button>
                <button type="submit" class="btn-danger" id="finalizeSubmit">Finalize Application</button>
            </div>
        </form>
    </div>
</div>

    <div id="editModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Edit Platform</h3>
                <span class="close">&times;</span>
            </div>
            <form id="editForm" method="post" class="form_platforms">
                <input type="text" id="edit_platform_name" name="platform_name" placeholder="Platform Name" class="form-input" required>
                <input type="text" id="edit_platform_url" name="platform_url" placeholder="Platform URL" class="form-input" required>
                <button type="submit" class="btn-primary">Update Platform</button>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3>Delete Application</h3>
                <span class="close-delete">&times;</span>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this application?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelDelete">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const addApplicationBtn = document.getElementById('addApplicationBtn');
    const addApplicationModal = document.getElementById('addApplicationModal');
    const closeAddBtn = document.querySelector('.close-add');
    const applicationCards = document.querySelectorAll('.application-card');
    const applicationsGrid = document.querySelector('.applications-grid');
    
    // Create "no results" message
    const noResultsDiv = document.createElement('div');
    noResultsDiv.className = 'no-results';
    noResultsDiv.textContent = 'No applications found matching your search.';
    noResultsDiv.style.display = 'none';
    applicationsGrid.appendChild(noResultsDiv);
    
    // Search functionality
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let visibleCards = 0;
        
        applicationCards.forEach(card => {
            const company = card.querySelector('.company-section h3').textContent.toLowerCase();
            const role = card.querySelector('.company-section .role').textContent.toLowerCase();
            const date = card.querySelector('.date').textContent.toLowerCase();
            const platform = card.querySelector('.platform').textContent.toLowerCase();
            const step = card.querySelector('.step-badge').textContent.toLowerCase();
            const feedback = card.querySelector('.feedback').textContent.toLowerCase();
            const salary = card.querySelector('.salary').textContent.toLowerCase();
            
            const matches = company.includes(searchTerm) || 
                           role.includes(searchTerm) || 
                           date.includes(searchTerm) || 
                           platform.includes(searchTerm) || 
                           step.includes(searchTerm) || 
                           feedback.includes(searchTerm) || 
                           salary.includes(searchTerm);
            
            if (matches || searchTerm === '') {
                card.style.display = '';
                visibleCards++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCards === 0 && searchTerm !== '') {
            noResultsDiv.style.display = 'block';
        } else {
            noResultsDiv.style.display = 'none';
        }
    }
    
    // Search events
    searchInput.addEventListener('input', performSearch);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Add application modal
    addApplicationBtn.addEventListener('click', function() {
        addApplicationModal.classList.add('show');
    });
    
    closeAddBtn.addEventListener('click', function() {
        addApplicationModal.classList.remove('show');
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === addApplicationModal) {
            addApplicationModal.classList.remove('show');
        }
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Adiciona evento de clique para todos os botões de expandir
    document.querySelectorAll('.btn-expand-mini').forEach(button => {
        button.addEventListener('click', function() {
            // Encontra o card pai
            const card = this.closest('.application-card');
            const details = card.querySelector('.card-details');
            const icon = this.querySelector('i');
            
            if (details.style.display === 'none' || details.style.display === '') {
                // Mostra detalhes
                details.style.display = 'block';
                icon.className = 'fa-solid fa-chevron-up';
                this.title = 'Hide details';
            } else {
                // Esconde detalhes
                details.style.display = 'none';
                icon.className = 'fa-solid fa-chevron-down';
                this.title = 'Show details';
            }
        });
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Modal elements
    const addStepModal = document.getElementById('addStepModal');
    const finalizeModal = document.getElementById('finalizeModal');
    const addStepForm = document.getElementById('addStepForm');
    const finalizeForm = document.getElementById('finalizeForm');
    
    // Button elements
    const addStepButtons = document.querySelectorAll('.add-step-btn');
    const finalizeButtons = document.querySelectorAll('.finalize-btn');
    
    // Close button elements
    const closeStepBtn = document.querySelector('.close-step');
    const closeFinalizeBtn = document.querySelector('.close-finalize');
    const cancelAddStepBtn = document.getElementById('cancelAddStep');
    const cancelFinalizeBtn = document.getElementById('cancelFinalize');
    
    // Add Step Modal
    addStepButtons.forEach(button => {
        button.addEventListener('click', function() {
            const applicationId = this.dataset.applicationId;
            const applicationCompany = this.dataset.applicationCompany;
            const applicationRole = this.dataset.applicationRole;
            
            // Set form action
            addStepForm.action = `/applications/${applicationId}/add-step`;
            
            // Update info text
            document.getElementById('stepApplicationInfo').textContent = 
                `Adding step for: ${applicationRole} at ${applicationCompany}`;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="step_date"]').value = today;
            
            // Show modal
            addStepModal.classList.add('show');
        });
    });
    
    // Finalize Modal
    finalizeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const applicationId = this.dataset.applicationId;
            const applicationCompany = this.dataset.applicationCompany;
            const applicationRole = this.dataset.applicationRole;
            
            // Set form action
            finalizeForm.action = `/applications/${applicationId}/finalize`;
            
            // Update info text
            document.getElementById('finalizeApplicationInfo').textContent = 
                `Finalizing: ${applicationRole} at ${applicationCompany}`;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="finalize_date"]').value = today;
            
            // Show modal
            finalizeModal.classList.add('show');
        });
    });
    
    // Show/hide salary offer field based on final result
    const finalStepSelect = document.querySelector('select[name="final_step"]');
    const salaryOfferGroup = document.getElementById('salaryOfferGroup');
    const finalizeSubmit = document.getElementById('finalizeSubmit');
    
    finalStepSelect.addEventListener('change', function() {
        if (this.value === '7') { // Offer
            salaryOfferGroup.style.display = 'block';
            finalizeSubmit.textContent = 'Accept Offer';
            finalizeSubmit.className = 'btn-primary';
        } else if (this.value === '8') { // Denied
            salaryOfferGroup.style.display = 'none';
            finalizeSubmit.textContent = 'Mark as Denied';
            finalizeSubmit.className = 'btn-danger';
        } else {
            salaryOfferGroup.style.display = 'none';
            finalizeSubmit.textContent = 'Finalize Application';
            finalizeSubmit.className = 'btn-danger';
        }
    });
    
    // Close modal functions
    closeStepBtn.addEventListener('click', () => addStepModal.classList.remove('show'));
    closeFinalizeBtn.addEventListener('click', () => finalizeModal.classList.remove('show'));
    cancelAddStepBtn.addEventListener('click', () => addStepModal.classList.remove('show'));
    cancelFinalizeBtn.addEventListener('click', () => finalizeModal.classList.remove('show'));
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === addStepModal) {
            addStepModal.classList.remove('show');
        }
        if (event.target === finalizeModal) {
            finalizeModal.classList.remove('show');
        }
    });
});
</script>

<script>
    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    const closeDeleteBtn = document.querySelector('.close-delete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const deleteButtons = document.querySelectorAll('.delete-btn');

    // Open delete modal when delete button is clicked
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const applicationId = this.dataset.applicationId;
            const applicationCompany = this.dataset.applicationCompany;
            const applicationRole = this.dataset.applicationRole;
            // Set form action to delete route
            deleteForm.action = `/applications/${applicationId}/delete`;

            // Update message with platform name
            document.getElementById('deleteMessage').textContent = 
                `Are you sure you want to delete "${applicationRole} at ${applicationCompany}"?`;
            // Show modal
            deleteModal.classList.add('show');
        });
    });

    // Close delete modal
    closeDeleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('show');
    });

    cancelDeleteBtn.addEventListener('click', function() {
        deleteModal.classList.remove('show');
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === deleteModal) {
            deleteModal.classList.remove('show');
        }
    });
</script>

<script>
    const platformNameInput = document.getElementById('platform_name');
    const platformUrlInput = document.getElementById('platform_url');
    const createPlatformBtn = document.getElementById('createPlatformBtn');

    function validateCreateForm() {
        const nameValue = platformNameInput.value.trim();
        const urlValue = platformUrlInput.value.trim();

        // Enable button only if both fields have text
        if (nameValue.length > 0 && urlValue.length > 0) {
            createPlatformBtn.disabled = false;
        } else {
            createPlatformBtn.disabled = true;
        }
    }

    // Add event listeners to both inputs
    platformNameInput.addEventListener('input', validateCreateForm);
    platformUrlInput.addEventListener('input', validateCreateForm);

    // Initial validation check
    validateCreateForm();
</script>
{% endblock %}